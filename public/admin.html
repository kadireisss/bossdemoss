<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>BossMedya â€“ Live Analytics Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #020617;
      --bg-alt: #0b1120;
      --card: #020617;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.15);
      --danger: #f97373;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --online-dot: #22c55e;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }
    html, body {
      height: 100%;
      background: radial-gradient(circle at top, #020617 0, #000 55%, #000 100%);
      color: var(--text-main);
    }
    body.locked {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lock-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 28px 24px 22px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.9);
      width: 90%;
      max-width: 380px;
      text-align: center;
    }
    .lock-card h1 {
      font-size: 22px;
      margin-bottom: 6px;
    }
    .lock-card p {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .lock-card input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      outline: none;
      font-size: 14px;
    }
    .lock-card button {
      width: 100%;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, #22d3ee, #0ea5e9);
      color: #020617;
    }
    .lock-hint {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .app {
      min-height: 100vh;
      display: none;
      flex-direction: column;
    }
    header {
      padding: 16px 18px 8px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.3), transparent),
        radial-gradient(circle at top right, rgba(129, 140, 248, 0.3), transparent),
        rgba(15, 23, 42, 0.96);
      backdrop-filter: blur(24px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 30%, #f97316, #ec4899);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 17px;
      color: #020617;
      box-shadow: 0 12px 30px rgba(236, 72, 153, 0.7);
    }
    .logo-text {
      display: flex;
      flex-direction: column;
    }
    .logo-text span:first-child {
      font-size: 15px;
      font-weight: 600;
    }
    .logo-text span:last-child {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }
    .header-meta {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }
    .env-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 5px 9px;
      background: rgba(15, 23, 42, 0.9);
    }
    .env-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--online-dot);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.16);
    }
    .loading-bar {
      margin-top: 10px;
      height: 2px;
      width: 0;
      background: linear-gradient(90deg, #22d3ee, #6366f1);
      border-radius: 999px;
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.9);
      transition: width 0.6s ease-out;
    }
    .loading-bar.active {
      width: 100%;
    }
    main {
      flex: 1;
      padding: 18px 14px 22px;
    }
    .container {
      max-width: 1120px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 2.4fr) minmax(0, 1.8fr);
      gap: 16px;
    }
    .section-title {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .card {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
      border-radius: 16px;
      padding: 12px 12px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      position: relative;
      overflow: hidden;
    }
    .card-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }
    .card-value {
      margin-top: 6px;
      font-size: 22px;
      font-weight: 600;
    }
    .card-sub {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill {
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: var(--accent-soft);
      color: var(--accent);
    }
    .pill.good {
      background: rgba(52, 211, 153, 0.18);
      color: #6ee7b7;
    }
    .pill.bad {
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
    }
    .panel {
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 16px;
      padding: 14px 14px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      min-height: 240px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 500;
    }
    .panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }
    .badge {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 11px;
      color: var(--text-muted);
    }
    canvas {
      width: 100% !important;
      height: 210px !important;
    }
    .events-body {
      margin-top: 6px;
      max-height: 230px;
      overflow: auto;
      scrollbar-width: thin;
    }
    .events-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .events-table th,
    .events-table td {
      padding: 6px 6px;
      text-align: left;
    }
    .events-table thead {
      position: sticky;
      top: 0;
      background: #020617;
      box-shadow: 0 1px 0 rgba(31, 41, 55, 0.9);
    }
    .events-table th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }
    .events-table tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.85);
    }
    .events-table tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.65);
    }
    .url,
    .ref {
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ip-address {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }
    footer {
      padding: 8px 14px 16px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.7;
    }
    @media (max-width: 960px) {
      .container {
        grid-template-columns: minmax(0, 1fr);
      }
      .cards {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 640px) {
      main {
        padding: 14px 10px 16px;
      }
      .cards {
        grid-template-columns: minmax(0, 1fr);
      }
      canvas {
        height: 190px !important;
      }
    }
  </style>
</head>
<body>
  <div id="lock-root"></div>

  <div id="app-root" class="app">
    <header>
      <div class="header-inner">
        <div class="logo">
          <div class="logo-badge">B</div>
          <div class="logo-text">
            <span>BossMedya Analytics</span>
            <span>Live Traffic Â· Upstash Â· Vercel</span>
          </div>
        </div>
        <div class="header-meta">
          <div class="env-chip">
            <div class="env-dot"></div>
            <span>LIVE MODE</span>
          </div>
          <div id="lastUpdateText">Son gÃ¼ncelleme: â€“</div>
        </div>
      </div>
      <div id="loadingBar" class="loading-bar"></div>
    </header>

    <main>
      <div class="container">
        <section>
          <div class="section-title">Ã–zet</div>
          <div class="cards">
            <div class="card">
              <div class="card-label">BugÃ¼n</div>
              <div class="card-value" id="todayVisitors">0</div>
              <div class="card-sub">
                <span>Toplam ziyaretÃ§i</span>
                <span class="pill good" id="totalChangeLabel">â€“</span>
              </div>
            </div>
            <div class="card">
              <div class="card-label">Toplam</div>
              <div class="card-value" id="totalVisitors">0</div>
              <div class="card-sub">
                <span>Toplam benzersiz oturum</span>
              </div>
            </div>
            <div class="card">
              <div class="card-label">Åžu an online</div>
              <div class="card-value" id="onlineNow">0</div>
              <div class="card-sub">
                <span class="pill">Son 5 dk</span>
                <span id="bestHour">En yoÄŸun saat: â€“</span>
              </div>
            </div>
            <div class="card">
              <div class="card-label">Bounce Rate</div>
              <div class="card-value" id="bounceRate">0%</div>
              <div class="card-sub">
                <span>Ortalama sayfa / oturum: <strong id="avgSessOnPages">0</strong></span>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Son 14 gÃ¼n trafiÄŸi</div>
                <div class="panel-subtitle" id="bestDay">En iyi gÃ¼n: â€“</div>
              </div>
              <div class="badge">14 gÃ¼nlÃ¼k gÃ¶rÃ¼nÃ¼m</div>
            </div>
            <canvas id="trafficChart"></canvas>
          </div>
        </section>

        <section>
          <div class="section-title">Son hareketler</div>
          <div class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Son hitler</div>
                <div class="panel-subtitle">Son 50 isteÄŸi buradan izleyebilirsin</div>
              </div>
              <div class="badge" id="eventsCountBadge">0 kayÄ±t</div>
            </div>
            <div class="events-body" id="eventsBody">
              <div style="height:180px;border-radius:12px;border:1px dashed rgba(55,65,81,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:var(--text-muted);background:radial-gradient(circle at top,rgba(15,23,42,0.9),transparent);">
                <div style="font-size:20px;margin-bottom:4px;">ðŸ›°</div>
                <div>HenÃ¼z event verisi gelmedi.</div>
                <div>GerÃ§ek trafik geldikÃ§e son 50 hit burada listelenecek.</div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <div>Â© <span id="year"></span> BossMedya Â· Internal Analytics</div>
        <div>Upstash KV + Vercel Edge Â· Track endpoint: <code>/api/track</code></div>
      </div>
    </footer>
  </div>

  <script>
    const ADMIN_PASSWORD = "656634";

    function renderLockScreen() {
      document.body.className = "locked";
      document.getElementById("app-root").style.display = "none";
      const root = document.getElementById("lock-root");
      root.innerHTML = `
        <div class="lock-card">
          <h1>BossMedya Admin GiriÅŸi</h1>
          <p>Bu panel yalnÄ±zca iÃ§ kullanÄ±m iÃ§indir. LÃ¼tfen yÃ¶netici ÅŸifresini gir.</p>
          <input type="password" id="lockPassword" placeholder="YÃ¶netici ÅŸifresi" />
          <button id="lockButton">Panele giriÅŸ yap</button>
          <div class="lock-hint">URL parametresi <code>?pwd=656634</code> ile de direkt giriÅŸ yapabilirsin.</div>
        </div>
      `;

      document.getElementById("lockButton").onclick = () => {
        const val = document.getElementById("lockPassword").value.trim();
        if (val === ADMIN_PASSWORD) {
          const url = new URL(window.location.href);
          url.searchParams.set("pwd", ADMIN_PASSWORD);
          window.location.href = url.toString();
        } else {
          alert("YanlÄ±ÅŸ ÅŸifre!");
        }
      };
    }

    function unlockApp() {
      document.body.className = "";
      document.getElementById("lock-root").innerHTML = "";
      document.getElementById("app-root").style.display = "flex";
      initAnalytics();
    }

    (function checkAccess() {
      const params = new URLSearchParams(window.location.search);
      const pwd = params.get("pwd");
      if (pwd === ADMIN_PASSWORD) {
        unlockApp();
      } else {
        renderLockScreen();
      }
    })();

    let chartInstance = null;

    function animateNumber(el, target, suffix = "", duration = 650) {
      const start = 0;
      const startTime = performance.now();
      function frame(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const value = Math.round(start + (target - start) * progress);
        el.textContent = value.toLocaleString("tr-TR") + suffix;
        if (progress < 1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function renderChart(labels, values) {
      const ctx = document.getElementById("trafficChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "ZiyaretÃ§i",
              data: values,
              borderColor: "#22d3ee",
              backgroundColor: "rgba(34, 211, 238, 0.12)",
              tension: 0.4,
              fill: true,
              borderWidth: 2,
              pointRadius: 3,
              pointBackgroundColor: "#38bdf8",
              pointHoverRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "#9ca3af", maxTicksLimit: 7 },
            },
            y: {
              grid: { color: "rgba(55,65,81,0.7)" },
              ticks: { color: "#9ca3af", precision: 0 },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "#020617",
              borderColor: "#1f2937",
              borderWidth: 1,
              padding: 10,
              displayColors: false,
            },
          },
        },
      });
    }

    function renderEvents(events) {
      const body = document.getElementById("eventsBody");
      const badge = document.getElementById("eventsCountBadge");

      if (!events || events.length === 0) {
        body.innerHTML = `
          <div style="height:180px;border-radius:12px;border:1px dashed rgba(55,65,81,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:var(--text-muted);background:radial-gradient(circle at top,rgba(15,23,42,0.9),transparent);">
            <div style="font-size:20px;margin-bottom:4px;">ðŸ›°</div>
            <div>HenÃ¼z event verisi gelmedi.</div>
            <div>GerÃ§ek trafik geldikÃ§e son 50 hit burada listelenecek.</div>
          </div>
        `;
        badge.textContent = "0 kayÄ±t";
        return;
      }

      badge.textContent = `${events.length} kayÄ±t`;

      const rows = events
        .map(
          (e) => `
        <tr>
          <td class="ip-address">${e.ip || "-"}</td>
          <td class="url" title="${e.path || e.page || "-"}">${e.path || e.page || "-"}</td>
          <td class="ref" title="${e.referrer || "-"}">${e.referrer || "-"}</td>
          <td>${e.country || "-"}</td>
          <td>${e.ua || e.device || "-"}</td>
          <td>${e.time || "-"}</td>
        </tr>
      `
        )
        .join("");

      body.innerHTML = `
        <table class="events-table">
          <thead>
            <tr>
              <th>IP</th>
              <th>URL</th>
              <th>Ref</th>
              <th>Ãœlke</th>
              <th>Cihaz</th>
              <th>Zaman</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    async function initAnalytics() {
      const loadingBar = document.getElementById("loadingBar");
      const lastUpdateText = document.getElementById("lastUpdateText");
      const yearEl = document.getElementById("year");
      yearEl.textContent = new Date().getFullYear().toString();

      try {
        loadingBar.classList.add("active");
        const res = await fetch("/api/stats");
        const data = await res.json();

        const s = data.summary || {};
        const chart = data.chart || { labels: [], values: [] };
        const events = data.events || [];

        animateNumber(
          document.getElementById("todayVisitors"),
          s.todayVisitors || 0
        );
        animateNumber(
          document.getElementById("totalVisitors"),
          s.totalVisitors || 0
        );
        animateNumber(
          document.getElementById("onlineNow"),
          s.onlineNow || 0
        );
        animateNumber(
          document.getElementById("bounceRate"),
          s.bounceRate || 0,
          "%"
        );

        setText(
          "avgSessOnPages",
          (s.avgSessOnPages || s.avgSessionPages || 0).toString()
        );
        setText("bestDay", "En iyi gÃ¼n: " + (s.bestDay || "â€“"));
        setText("bestHour", "En yoÄŸun saat: " + (s.bestHour || "â€“"));
        setText(
          "totalChangeLabel",
          s.totalChangeLabel || "-"
        );

        renderChart(chart.labels || [], chart.values || []);
        renderEvents(events);

        const now = new Date();
        lastUpdateText.textContent =
          "Son gÃ¼ncelleme: " +
          now.toLocaleString("tr-TR", {
            hour: "2-digit",
            minute: "2-digit",
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });
      } catch (err) {
        console.error("Stats yÃ¼klenirken hata:", err);
        alert("Stats API okunurken bir hata oluÅŸtu. Konsolu kontrol et.");
      } finally {
        setTimeout(() => loadingBar.classList.remove("active"), 500);
      }
    }
  </script>
</body>
</html>
